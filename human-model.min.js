// (c) 2013 Henrik Joreteg
// MIT Licensed
// For all details and documentation:
// https://github.com/HenrikJoreteg/human-model
// 
// Built: 2013-11-12:11:45

!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["underscore","backbone"],function(c,d){return a.HumanModel=b(c,d)}):"object"==typeof exports?module.exports=b(require("underscore"),require("backbone")):a.HumanModel=b(a._,a.Backbone)}(this,function(a,b){"use strict";var c=Array.prototype.slice;b.Collection.prototype._prepareModel=function(b,c){if(a.isFunction(b.initialize))return b.collection||(b.collection=this),b;c||(c={}),c.collection=this;var d=new this.model(b,c);return d._validate(b,c)?d:(this.trigger("invalid",this,b,c),!1)};var d=function(a,b){var c=a.length,d=a.indexOf(b)+1;return d>c-1&&(d=0),a[d]},e=function(b,c,d){var e=b._derived[c]={fn:a.isFunction(d)?d:d.fn,cache:d.cache!==!1,depList:d.deps||[]};a.each(e.depList,function(d){b._deps[d]=a(b._deps[d]||[]).union([c])}),Object.defineProperty(b,c,{get:function(){return this._derived[c].cache?this._cache[c]||(this._cache[c]=this._derived[c].fn.apply(this)):this._derived[c].fn.apply(this)},set:function(){throw new TypeError('"'+c+"\" is a derived property, it can't be set directly.")}})},f=function(){this._cache={},this._namespaces={}};a.extend(f.prototype,{_getCache:function(a){return a?(this._namespaces[a]||(this._namespaces[a]={}),this._namespaces[a]):this._cache},lookup:function(a,b,c){var d=this._getCache(c);return d&&d[a+b]},store:function(a){var b=this._getCache(a._namespace),c=a.type+a.getId();return b[c]=b[c]||a,this},remove:function(a,b,c){var d=this._getCache(c);return this.lookup.apply(this,arguments)?(delete d[a+b],!0):!1},clear:function(){this._cache={},this._namespaces={}}});var g=new f,h={date:{set:function(b){var c;if(a.isDate(b))c="date",b=b.valueOf();else try{b=new Date(parseInt(b,10)).valueOf(),c="date"}catch(d){c=typeof b}return{val:b,type:c}},get:function(a){return new Date(a)}},array:{set:function(b){return{val:b,type:a.isArray(b)?"array":typeof b}}},object:{set:function(b){var c=typeof b;return"object"!==c&&a.isUndefined(b)&&(b=null,c="object"),{val:b,type:c}}}},i=function(f){f||(f={});var i,l=function(b,c){b||(b={}),c||(c={}),this.cid=a.uniqueId("model"),this.collection=c.collection||void 0,c.parse&&(b=this.parse(b,c)||{}),this.registry=c.registry||g,c._attrs=b,this._namespace=c.namespace,this._initted=!1,this._values={},this._initCollections(),this._cache={},this._previousAttributes={},this._events={},this.set(b,a.extend({silent:!0},c)),this._changed={},this.initialize.apply(this,arguments),b[this.idAttribute]&&this.registry.store(this),this._initted=!0,this.seal&&Object.seal(this)};Object.defineProperties(l.prototype,{attributes:{get:function(){return this._getAttributes(!0)}},json:{get:function(){return JSON.stringify(this.serialize())}},derived:{get:function(){var a={};for(var b in this._derived)a[b]=this._derived[b].fn.apply(this);return a}},toTemplate:{get:function(){return a.extend(this._getAttributes(!0),this.derived)}}}),a.extend(l.prototype,b.Events,{idAttribute:"id",_derived:{},_deps:{},_definition:{},extraProperties:"ignore",getId:function(){return this.get(this.idAttribute)},initialize:function(){return this},parse:function(a){return a},serialize:function(){return this._getAttributes(!1,!0)},remove:function(){return this.getId()&&this.registry.remove(this.type,this.getId(),this._namespace),this.trigger("remove",this),this.off(),this},set:function(b,c,d){function e(b){v.push(b),a.each(r._deps[b]||[],function(a){e(a)})}var f,g,i,j,k,l,m,n,o,p,q,r=this,s=this.extraProperties;if(a.isObject(b)||null===b?(n=b,d=c):(n={},n[b]=c),d=d||{},!this._validate(n,d))return!1;p=d.unset,o=d.silent,i=[],f=this._changing,this._changing=!0,f||(this._previousAttributes=this._getAttributes(!0),this._changed={}),g=this._previousAttributes;for(m in n){if(k=n[m],j=typeof k,q=this._values[m],l=this._definition[m],!l){if("ignore"===s)continue;if("reject"===s)throw new TypeError('No "'+m+'" property defined on '+(this.type||"this")+" model and allowOtherProperties not set.");"allow"===s&&(l=this._createPropertyDefinition(m,"any"))}if(h[l.type]){var t=h[l.type].set(k);k=t.val,j=t.type}if(l.test){var u=l.test(k,j);if(u)throw new TypeError("Property '"+m+"' failed validation with error: "+u)}if(a.isUndefined(k)&&l.required)throw new TypeError("Required property '"+m+"' must be of type "+l.type+". Tried to set "+k);if(a.isNull(k)&&l.required&&!l.allowNull)throw new TypeError("Property '"+m+"' must be of type "+l.type+" (cannot be null). Tried to set "+k);if(l.type&&"any"!==l.type&&l.type!==j&&!a.isNull(k)&&!a.isUndefined(k))throw new TypeError("Property '"+m+"' must be of type "+l.type+". Tried to set "+k);if(l.values&&!a.contains(l.values,k))throw new TypeError("Property '"+m+"' must be one of values: "+l.values.map(function(a){return a.toString()}).join(", "));if(l.setOnce&&void 0!==q&&!a.isEqual(q,k))throw new TypeError("Property '"+b+"' can only be set once.");a.isEqual(q,k)||i.push({prev:q,val:k,key:m}),a.isEqual(g[m],k)?delete r._changed[m]:r._changed[m]=k}a.each(i,function(a){r._previousAttributes[a.key]=a.prev,p?delete r._values[a.key]:r._values[a.key]=a.val});var v=[];if(!o&&i.length&&(r._pending=!0),a.each(i,function(a){e(a.key)}),a.each(a.uniq(v),function(a){var b=r._derived[a];b&&b.cache&&(r._previousAttributes[a]=r._cache[a],delete r._cache[a]),o||r.trigger("change:"+a,r,r[a])}),f)return this;if(!o)for(;this._pending;)this._pending=!1,this.trigger("change",this,d);return this._pending=!1,this._changing=!1,this},get:function(a){return this[a]},toggle:function(a){var b=this._definition[a];if("boolean"===b.type)this[a]=!this[a];else{if(!b||!b.values)throw new TypeError("Can only toggle properties that are type `boolean` or have `values` array.");this[a]=d(b.values,this[a])}return this},previousAttributes:function(){return a.clone(this._previousAttributes)},save:function(b,c,d){var e,f,g;if(this.attributes,null==b||"object"==typeof b?(e=b,d=c):(e={})[b]=c,d=a.extend({validate:!0},d),e&&!d.wait){if(!this.set(e,d))return!1}else if(!this._validate(e,d))return!1;void 0===d.parse&&(d.parse=!0);var h=this,i=d.success;return d.success=function(b){var c=h.parse(b,d);return d.wait&&(c=a.extend(e||{},c)),a.isObject(c)&&!h.set(c,d)?!1:(i&&i(h,b,d),h.trigger("sync",h,b,d),void 0)},j(this,d),f=this.isNew()?"create":d.patch?"patch":"update","patch"===f&&(d.attrs=e),d.wait&&(d.attrs=a.extend(h.serialize(),e)),g=this.sync(f,this,d)},fetch:function(b){b=b?a.clone(b):{},void 0===b.parse&&(b.parse=!0);var c=this,d=b.success;return b.success=function(a){return c.set(c.parse(a,b),b)?(d&&d(c,a,b),c.trigger("sync",c,a,b),void 0):!1},j(this,b),this.sync("read",this,b)},destroy:function(b){b=b?a.clone(b):{};var c=this,d=b.success,e=function(){c.trigger("destroy",c,c.collection,b)};if(b.success=function(a){(b.wait||c.isNew())&&e(),d&&d(c,a,b),c.isNew()||c.trigger("sync",c,a,b)},this.isNew())return b.success(),!1;j(this,b);var f=this.sync("delete",this,b);return b.wait||e(),f},hasChanged:function(b){return null==b?!a.isEmpty(this._changed):a.has(this._changed,b)},changedAttributes:function(b){if(!b)return this.hasChanged()?a.clone(this._changed):!1;var c,d=!1,e=this._changing?this._previousAttributes:this._getAttributes(!0);for(var f in b)a.isEqual(e[f],c=b[f])||((d||(d={}))[f]=c);return d},toJSON:function(){return this.serialize()},has:function(a){return null!=this.get(a)},url:function(){var b=a.result(this,"urlRoot")||a.result(this.collection,"url")||k();return this.isNew()?b:b+("/"===b.charAt(b.length-1)?"":"/")+encodeURIComponent(this.getId())},isNew:function(){return null==this.getId()},clone:function(){return new this.constructor(this._getAttributes(!0))},isValid:function(b){return this._validate({},a.extend(b||{},{validate:!0}))},escape:function(b){return a.escape(this[b])},sync:function(){return b.sync.apply(this,arguments)},unset:function(b,c){var d,e=this._definition[b],f=e.type;return e.required?(d=a.isUndefined(e.default)?this._getDefaultForType(f):e.default,this.set(b,d,c)):this.set(b,d,a.extend({},c,{unset:!0}))},clear:function(b){var c=this;return a.each(this._getAttributes(!0),function(a,d){c.unset(d,b)}),this},_validate:function(b,c){if(!c.validate||!this.validate)return!0;b=a.extend({},this.attributes,b);var d=this.validationError=this.validate(b,c)||null;return d?(this.trigger("invalid",this,d,a.extend(c||{},{validationError:d})),!1):!0},_getDefaultForType:function(a){return"string"===a?"":"object"===a?{}:"array"===a?[]:void 0},addListVal:function(b,c,d){var e=a.clone(this[b])||[];return a(e).contains(c)||(e[d?"unshift":"push"](c),this[b]=e),this},previous:function(a){return null!=a&&Object.keys(this._previousAttributes).length?this._previousAttributes[a]:null},removeListVal:function(b,c){var d=a.clone(this[b])||[];return a(d).contains(c)&&(this[b]=a(d).without(c)),this},hasListVal:function(b,c){return a.contains(this[b]||[],c)},_initCollections:function(){var a;if(this._collections)for(a in this._collections)this[a]=new this._collections[a],this[a].parent=this},_verifyRequired:function(){var a=this._getAttributes(!0);for(var b in this._definition)if(this._definition[b].required&&"undefined"==typeof a[b])return!1;return!0},_createPropertyDefinition:function(b,c,d){var e,f=this,g=this._definition[b]={};return a.isString(c)?(e=this._ensureValidType(c),e&&(g.type=e)):(e=this._ensureValidType(c[0]||c.type),e&&(g.type=e),(c[1]||c.required)&&(g.required=!0),g.default=a.isUndefined(c[2])?c.default:c[2],g.allowNull=c.allowNull?c.allowNull:!1,c.setOnce&&(g.setOnce=!0),g.required&&a.isUndefined(g.default)&&(g.default=this._getDefaultForType(e)),g.test=c.test,g.values=c.values),d&&(g.session=!0),Object.defineProperty(f,b,{set:function(a){this.set(b,a)},get:function(){var a=this._values[b];return"undefined"!=typeof a?(h[g.type]&&h[g.type].get&&(a=h[g.type].get(a)),a):g.default}}),g},_ensureValidType:function(b){return a.contains(["string","number","boolean","array","object","date","any"].concat(a.keys(h)),b)?b:void 0},_getAttributes:function(a,b){var c,d,e,f={};for(d in this._definition)e=this._definition[d],(!e.session||a&&e.session)&&(c=b?this._values[d]:this[d],"undefined"==typeof c&&(c=e.default),"undefined"!=typeof c&&(f[d]=c));return f}});var m=["keys","values","pairs","invert","pick","omit"];a.each(m,function(b){l.prototype[b]=function(){var d=c.call(arguments);return d.unshift(this.attributes),a[b].apply(a,d)}});for(i in f)"props"===i||"session"===i?a.each(f[i],function(a,b){l.prototype._createPropertyDefinition.call(l.prototype,b,a,"session"===i)}):"derived"===i?a.each(f[i],function(a,b){e(l.prototype,b,a)}):"collections"===i?l.prototype._collections=f[i]:l.prototype[i]=f[i];return l.registry=g,l},j=function(a,b){var c=b.error;b.error=function(d){c&&c(a,d,b),a.trigger("error",a,d,b)}},k=function(){throw new Error('A "url" property or function must be specified')};return{define:i,registry:g,Registry:f,dataTypes:h}});